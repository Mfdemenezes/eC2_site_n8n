name: 'ğŸ—‘ï¸ Destroy AWS Infrastructure'

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm destruction'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Staging
          - Production

permissions:
  contents: read

env:
  TF_VAR_region: "us-east-1"
  AWS_DEFAULT_REGION: "us-east-1"

jobs:
  destroy:
    name: 'ğŸ—‘ï¸ Terraform Destroy'
    runs-on: ubuntu-latest
    environment: production
    
    defaults:
      run:
        shell: bash

    steps:
    # Validation check
    - name: Validate Confirmation
      run: |
        if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
          echo "âŒ ConfirmaÃ§Ã£o invÃ¡lida! Digite exatamente 'DESTROY' para confirmar."
          exit 1
        fi
        echo "âœ… ConfirmaÃ§Ã£o vÃ¡lida para destruiÃ§Ã£o da infraestrutura"

    # Checkout the repository
    - name: Checkout
      uses: actions/checkout@v4

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.8.5"

    # Configure AWS credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # Verify AWS credentials
    - name: Verify AWS credentials
      run: |
        echo "ğŸ” Verificando credenciais AWS..."
        aws sts get-caller-identity

    # Initialize Terraform
    - name: Terraform Init
      run: terraform init -reconfigure

    # Show current state
    - name: Show Current Infrastructure
      run: |
        echo "ğŸ“‹ Infraestrutura atual que serÃ¡ destruÃ­da:"
        terraform show || echo "Nenhuma infraestrutura encontrada"

    # Plan destruction
    - name: Terraform Plan Destroy
      run: |
        echo "ğŸ—‘ï¸ Planejando destruiÃ§Ã£o da infraestrutura..."
        terraform plan -destroy -input=false -out=destroy-plan
        echo "ğŸ“‹ Plano de destruiÃ§Ã£o:"
        terraform show destroy-plan

    # Destroy infrastructure
    - name: Terraform Destroy
      run: |
        echo "ğŸ’¥ INICIANDO DESTRUIÃ‡ÃƒO DA INFRAESTRUTURA..."
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        terraform apply -auto-approve destroy-plan
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Infraestrutura destruÃ­da com sucesso!"

    # Verify destruction
    - name: Verify Destruction
      run: |
        echo "ğŸ” Verificando se todos os recursos foram destruÃ­dos..."
        terraform show || echo "âœ… Nenhum recurso encontrado - destruiÃ§Ã£o completa!"

    # Summary
    - name: Destruction Summary
      run: |
        echo "ğŸ¯ RESUMO DA DESTRUIÃ‡ÃƒO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Infraestrutura AWS destruÃ­da com sucesso"
        echo "ğŸŒ RegiÃ£o: us-east-1"
        echo "ğŸ·ï¸ Environment: ${{ github.event.inputs.environment }}"
        echo "â° Timestamp: $(date)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ’¡ Para recriar a infraestrutura, execute o workflow 'Deploy'"
