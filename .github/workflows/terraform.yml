name: 'AWS Infrastructure Base - EC2 with Docker & Git'

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

env:
  TF_VAR_region: "us-east-1"
  AWS_DEFAULT_REGION: "us-east-1"

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4

    # Install the latest version of Terraform CLI and configure the Terraform CLI configuration file with a Terraform Cloud user API token
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.8.5"

    # Configure AWS credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # Verify AWS credentials
    - name: Verify AWS credentials
      run: |
        echo "Verificando credenciais AWS..."
        aws sts get-caller-identity

    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Terraform Init
      run: terraform init -reconfigure

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: terraform fmt -check -recursive

    # Validates the configuration files in a directory, referring only to the configuration and not accessing any remote services
    - name: Terraform Validate
      run: terraform validate

    # Generates an execution plan for Terraform
    - name: Terraform Plan
      run: |
        echo "Criando plano de execuÃ§Ã£o..."
        terraform plan -input=false -out=tfplan
        terraform show tfplan

    # On push to "main", build or change infrastructure according to Terraform configuration files
    # Note: It is recommended to set up a required "strict" status check in your repository for "Terraform Cloud". See the documentation on "strict" required status checks for more information: https://help.github.com/en/github/administering-a-repository/types-of-required-status-checks
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "Deploy automÃ¡tico na branch main..."
        terraform apply -auto-approve -input=false tfplan
        echo "Deploy concluÃ­do!"

    # Generate outputs
    - name: Terraform Output
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "Gerando outputs..."
        terraform output -json > outputs.json
        echo "ğŸ“‹ Outputs gerados:"
        cat outputs.json

    # Upload outputs as artifacts
    - name: Upload outputs
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs
        path: outputs.json
        retention-days: 30

    # Display infrastructure information
    - name: Display Infrastructure Info
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š InformaÃ§Ãµes da Infraestrutura AWS:"
        if [ -f "outputs.json" ]; then
          echo "ğŸ¯ IPs das InstÃ¢ncias EC2:"
          cat outputs.json | jq -r '.instance_public_ips.value[]?' 2>/dev/null || echo "IPs nÃ£o encontrados"
          echo "ğŸŒ Acesso SSH:"
          PUBLIC_IP=$(cat outputs.json | jq -r '.instance_public_ips.value[0]?' 2>/dev/null)
          if [ "$PUBLIC_IP" != "null" ] && [ -n "$PUBLIC_IP" ]; then
            echo "   ssh -i sua-chave.pem ec2-user@$PUBLIC_IP"
          fi
        fi
        echo "ğŸ³ Docker e Git instalados e prontos para uso"
        echo "ï¿½ Infraestrutura base pronta para desenvolvimento"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
